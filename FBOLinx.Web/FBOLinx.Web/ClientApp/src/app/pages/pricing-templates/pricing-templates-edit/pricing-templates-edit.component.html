<ni-breadcrumb [menu]="breadcrumb"></ni-breadcrumb>

<div class="after-breadcrumb">
    <div *ngIf="!pricingTemplate">
        <mat-spinner></mat-spinner>
    </div>

    <div *ngIf="pricingTemplateForm" [formGroup]="pricingTemplateForm">
        <div *ngIf="isSaving" class="ml-1 mb-1 text-success">Saving Changes <i class="fa fa-spinner fa-spin"></i></div>
        <div *ngIf="hasSaved" class="ml-1 mb-1 text-success">Changes Saved!</div>
        <div class="card-wrap">
            <h3 class="card-header h5">
                <div class="row">
                    <div class="col-12">
                        <span class="card-header-title">{{ pricingTemplateForm.value.name }}</span>
                        <button (click)="cancelPricingTemplateEdit()"
                                class="float-right close-btn"
                                mat-icon-button>
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>
            </h3>
            <div class="card-content">
                <div class="container-fluid">
                    <mat-tab-group>
                        <mat-tab label="General Information">
                            <h5>General Information</h5>

                            <mat-slide-toggle color="accent" formControlName="default">Default</mat-slide-toggle>

                            <div class="mt-2 d-flex">
                                <div class="pr-3" style="width: 300px;">
                                    <mat-form-field>
                                        <input formControlName="name"
                                                matInput
                                                placeholder="Name"/>
                                    </mat-form-field>
                                </div>
                                <div style="width: 300px;">
                                    <mat-form-field>
                                        <mat-select formControlName="marginType"
                                                    placeholder="Type">
                                            <mat-option *ngFor="let marginType of marginTypeDataSource"
                                                        [value]="marginType.value">
                                                {{ marginType.text }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>

                            <h5 class="mt-4">Volume Tiers</h5>
                            <table class="mat-table table-responsive volume-tiers-table">
                                <thead>
                                    <tr class="mat-header-row">
                                        <th>
                                            <div class="">Min. (gal)</div>
                                        </th>
                                        <th>
                                            <div class="">Max. (gal)</div>
                                        </th>
                                        <th *ngIf="pricingTemplateForm.value.marginType == 1">
                                            <div class="">Discount</div>
                                        </th>
                                        <th>
                                            <div class="volume-tiers-header">Your ITP Margin</div>
                                        </th>
                                        <th>
                                            <div class="ml-4">
                                                <button (click)="addCustomerMargin()" [view]="'accent'" beforeIcon="fa fa-plus"
                                                        ni-button>
                                                    Add New
                                                </button>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody formArrayName="customerMargins">
                                    <tr *ngFor="let customerMargin of customerMarginsFormArray.controls; let i = index"
                                        class="mat-row">
                                        <td [formGroupName]="i" class="">
                                            <div class="volume-tiers-width">
                                                <mat-form-field class="">
                                                    <input formControlName="min" matInput/>
                                                </mat-form-field>
                                            </div>
                                        </td>
                                        <td class="">
                                            <div class="volume-tiers-width">
                                                <mat-form-field>
                                                    <input disabled="disabled"
                                                            matInput
                                                            value="{{customerMargin.value.max == 0 ? 99999 : customerMargin.value.max}}"/>
                                                </mat-form-field>
                                            </div>
                                        </td>
                                        <td *ngIf="pricingTemplateForm.value.marginType == 1" [formGroupName]="i">
                                            <div class="volume-tiers-width">
                                                <mat-form-field>
                                                    <input (click)="$event.target.select()"
                                                            formControlName="amount"
                                                            matInput
                                                            step="0.01"
                                                            type="number"/>
                                                    <span class="prefixDollar" matPrefix>$</span>
                                                </mat-form-field>
                                            </div>
                                        </td>
                                        <td [formGroupName]="i" class="font-weight-bold font-italic">
                                            <div>
                                                <div *ngIf="pricingTemplateForm.value.marginType == 1">
                                                    ${{ customerMargin.value.itp | number: "1.4-4" }}
                                                </div>
                                                <div class="volume-tiers-width">
                                                    <mat-form-field *ngIf="pricingTemplateForm.value.marginType == 0">
                                                        <input (click)="$event.target.select()"
                                                                formControlName="amount"
                                                                matInput
                                                                step="0.01"
                                                                type="number"/>
                                                        <span class="prefixDollar" matPrefix>$</span>
                                                    </mat-form-field>
                                                </div>
        
                                            </div>
                                        </td>
                                        <td class="">
                                            <div class="ml-4">
                                                <button (click)="deleteCustomerMargin(i)"
                                                        [view]="'error'"
                                                        beforeIcon="fa fa-trash"
                                                        ni-button
                                                        size="small">
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <h5 class="mt-2">Tax/Fee Exclusions</h5>
                            <div class="tax-fee-exclusions" *ngIf="feesAndTaxes">
                                <price-breakdown
                                    #priceBreakdownPreview
                                    (omitCheckChanged)="omitFeeAndTaxCheckChanged($event)"
                                    [feeAndTaxDisplayMode]="1"
                                    [feesAndTaxes]="feesAndTaxes"
                                    [priceTemplateId]="pricingTemplate.oid"
                                    priceBreakdownLoader="ITP-tax-fees-exclusion-loader"
                                    tooltipPlacement="left"
                                    [hidePriceTierBreakdown]="true"
                                ></price-breakdown>
                            </div>
        
                            <h5 class="mt-2">Fuel Uplift Notes</h5>
                            <ejs-richtexteditor #typeRTE
                                                formControlName="notes"
                                                id="rteNotes"></ejs-richtexteditor>
        
                            <div class="sub-title mt-5">
                                <h5 class="mb-0 mt-0">Price Distribution Email</h5>
                                <span class="flavor-label">Email subject and greeting</span>
                            </div>
                            <div>
                                <mat-form-field style="max-width: 600px;">
                                    <input aria-label="Subject"
                                           formControlName="subject"
                                           matInput
                                           placeholder="Subject"/>
                                </mat-form-field>
                            </div>
                            
                            <ejs-richtexteditor #typeEmail
                                                formControlName="email"
                                                id="rteEmail"
                                                placeholder="Enter email body here..."></ejs-richtexteditor>
                        </mat-tab>

                        <mat-tab label="Scenario Pricing">
                            <h5>Template Prices</h5>

                            <div class="sub-widget">
                                <price-breakdown #priceBreakdownPreview
                                                [hideFeeAndTaxGeneralBreakdown]="true"
                                                [priceTemplateId]="pricingTemplate.oid"
                                                priceBreakdownLoader="ITP-scenario-pricing-loader"
                                ></price-breakdown>
                            </div>
                        </mat-tab>
                    </mat-tab-group>
                </div>
            </div>
        </div>
    </div>
</div>
